"use strict";const e=require("electron"),i=require("path"),p=require("fs"),f=require("child_process");e.app.disableHardwareAcceleration();process.env.DIST=i.join(__dirname,"../dist");process.env.VITE_PUBLIC=e.app.isPackaged?process.env.DIST:i.join(process.env.DIST,"../public");let o,t=null,c=null,d=!1;const l=process.env.VITE_DEV_SERVER_URL;function u(){const n=["icon.ico","icon.png","vite.svg"];for(const a of n){const s=i.join(process.env.VITE_PUBLIC,a);if(p.existsSync(s))return s}return i.join(process.env.VITE_PUBLIC,"vite.svg")}function h(){t||(t=new e.BrowserWindow({width:120,height:120,frame:!1,transparent:!0,resizable:!1,alwaysOnTop:!0,skipTaskbar:!0,webPreferences:{preload:i.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!1}}),l?(t.loadURL(l+"#/float"),t.webContents.openDevTools({mode:"detach"})):t.loadFile(i.join(process.env.DIST,"index.html"),{hash:"float"}),t.on("close",n=>{d||(n.preventDefault(),t?.hide())}))}function g(){const n=u(),a=e.nativeImage.createFromPath(n);c=new e.Tray(a);const s=e.Menu.buildFromTemplate([{label:"Show App",click:()=>{o?.show()}},{label:"Quit",click:()=>{d=!0,e.app.quit()}}]);c.setToolTip("Time Statistic Analyzer"),c.setContextMenu(s),c.on("double-click",()=>{o?.show()})}function w(){const n=u();o=new e.BrowserWindow({icon:n,webPreferences:{preload:i.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!1}}),o.on("close",a=>{if(!d)return a.preventDefault(),o?.hide(),!1}),o.webContents.on("did-finish-load",()=>{o?.webContents.send("main-process-message",new Date().toLocaleString())}),l?o.loadURL(l):o.loadFile(i.join(process.env.DIST,"index.html"))}e.app.on("window-all-closed",()=>{process.platform});e.app.on("before-quit",()=>{d=!0});e.app.on("activate",()=>{e.BrowserWindow.getAllWindows().length===0?w():o?.show()});let r=null;function m(){const n=process.platform==="win32"?"api_server.exe":"api_server",a=e.app.isPackaged?i.join(process.resourcesPath,n):i.join(__dirname,"../../dist",n);p.existsSync(a)?(console.log("Starting backend from:",a),r=f.spawn(a,[],{cwd:e.app.getPath("userData")}),r.stdout?.on("data",s=>{console.log(`Backend: ${s}`)}),r.stderr?.on("data",s=>{console.error(`Backend Error: ${s}`)}),r.on("close",s=>{console.log(`Backend process exited with code ${s}`)})):console.log("Backend executable not found, assuming manual start or dev mode.")}function b(){r&&(console.log("Stopping backend..."),r.kill(),r=null)}e.app.on("will-quit",()=>{b()});e.app.whenReady().then(()=>{m(),w(),g(),h(),t?.hide(),e.ipcMain.handle("toggle-mini-mode",()=>o?.isVisible()?(o.hide(),t?.show(),!0):(t?.hide(),o?.show(),!1)),e.ipcMain.handle("switch-to-main",()=>(t?.hide(),o?.show(),!1)),e.ipcMain.on("timer-change",()=>{e.BrowserWindow.getAllWindows().forEach(n=>{n.webContents.send("timer-update")})}),e.ipcMain.on("category-change",()=>{e.BrowserWindow.getAllWindows().forEach(n=>{n.webContents.send("category-update")})})});
