"use strict";const e=require("electron"),i=require("path"),p=require("fs"),w=require("child_process");e.app.disableHardwareAcceleration();process.env.DIST=i.join(__dirname,"../dist");process.env.VITE_PUBLIC=e.app.isPackaged?process.env.DIST:i.join(process.env.DIST,"../public");let n,t=null,c=null,d=!1;const l=process.env.VITE_DEV_SERVER_URL;function u(){const o=["icon.ico","icon.png","vite.svg"];for(const a of o){const s=i.join(process.env.VITE_PUBLIC,a);if(p.existsSync(s))return s}return i.join(process.env.VITE_PUBLIC,"vite.svg")}function h(){t||(t=new e.BrowserWindow({width:120,height:120,frame:!1,transparent:!0,resizable:!1,alwaysOnTop:!0,skipTaskbar:!0,webPreferences:{preload:i.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!1}}),l?(t.loadURL(l+"#/float"),t.webContents.openDevTools({mode:"detach"})):t.loadFile(i.join(process.env.DIST,"index.html"),{hash:"float"}),t.on("close",o=>{d||(o.preventDefault(),t?.hide())}))}function g(){const o=u(),a=e.nativeImage.createFromPath(o);c=new e.Tray(a);const s=e.Menu.buildFromTemplate([{label:"Show App",click:()=>{n?.show()}},{label:"Quit",click:()=>{d=!0,e.app.quit()}}]);c.setToolTip("Time Statistic Analyzer"),c.setContextMenu(s),c.on("double-click",()=>{n?.show()})}function f(){const o=u();n=new e.BrowserWindow({icon:o,webPreferences:{preload:i.join(__dirname,"preload.js"),nodeIntegration:!0,contextIsolation:!1}}),n.on("close",a=>{if(!d)return a.preventDefault(),n?.hide(),!1}),n.webContents.on("did-finish-load",()=>{n?.webContents.send("main-process-message",new Date().toLocaleString())}),l?n.loadURL(l):n.loadFile(i.join(process.env.DIST,"index.html"))}e.app.on("window-all-closed",()=>{process.platform});e.app.on("before-quit",()=>{d=!0});e.app.on("activate",()=>{e.BrowserWindow.getAllWindows().length===0?f():n?.show()});let r=null;function m(){const o=process.platform==="win32"?"api_server.exe":"api_server",a=e.app.isPackaged?i.join(process.resourcesPath,o):i.join(__dirname,"../../dist",o);p.existsSync(a)?(console.log("Starting backend from:",a),r=w.spawn(a,[],{cwd:e.app.getPath("userData")}),r.stdout?.on("data",s=>{console.log(`Backend: ${s}`)}),r.stderr?.on("data",s=>{console.error(`Backend Error: ${s}`)}),r.on("close",s=>{console.log(`Backend process exited with code ${s}`)})):console.log("Backend executable not found, assuming manual start or dev mode.")}function b(){r&&(console.log("Stopping backend..."),r.kill(),r=null)}e.app.on("will-quit",()=>{b()});e.app.whenReady().then(()=>{m(),f(),g(),h(),t?.hide(),e.ipcMain.handle("toggle-mini-mode",()=>n?.isVisible()?(n.hide(),t?.show(),!0):(t?.hide(),n?.show(),!1)),e.ipcMain.handle("switch-to-main",()=>(t?.hide(),n?.show(),!1)),e.ipcMain.on("timer-change",()=>{e.BrowserWindow.getAllWindows().forEach(o=>{o.webContents.send("timer-update")})})});
